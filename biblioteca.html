<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biblioteca de Proyectos - San Isidro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --purple: #30115e;
            --purple-light: #4a1d7a;
            --purple-faint: #f3eeff;
            --green: #22c55e;
            --red: #ef4444;
            --orange: #f97316;
            --gdoc-blue: #1a73e8;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --gray-800: #1f2937;
            --shadow: rgba(0,0,0,0.3) 0px 1px 4px -1px;
            --radius: 8px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #f0edf6;
            min-height: 100vh;
            color: var(--gray-800);
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        #header {
            background: var(--purple);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            margin-bottom: -1px;
        }

        .header-left { display: flex; align-items: center; gap: 14px; }

        .back-btn {
            display: flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: none; cursor: pointer;
            transition: background 0.2s; text-decoration: none; flex-shrink: 0;
        }
        .back-btn:hover { background: rgba(255,255,255,0.2); }
        .back-btn svg { width: 20px; height: 20px; fill: white; }

        .header-titles h1 { font-size: 18px; font-weight: 700; line-height: 1.2; }
        .header-titles p  { font-size: 12px; opacity: 0.7; font-weight: 400; }

        /* ‚îÄ‚îÄ‚îÄ TOOLBAR ‚îÄ‚îÄ‚îÄ */
        .toolbar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 12px 24px;
            display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
            position: sticky; top: 73px; z-index: 90;
        }

        .toolbar-left { display: flex; align-items: center; gap: 10px; flex: 1; flex-wrap: wrap; }

        .search-box {
            display: flex; align-items: center; gap: 8px;
            background: var(--gray-50); border: 2px solid var(--gray-200);
            border-radius: 8px; padding: 8px 14px; min-width: 220px; transition: border-color 0.2s;
        }
        .search-box:focus-within { border-color: var(--purple); }
        .search-box svg { width: 16px; height: 16px; fill: var(--gray-400); flex-shrink: 0; }
        .search-box input {
            border: none; background: none; font-family: 'Montserrat', sans-serif;
            font-size: 13px; font-weight: 500; color: var(--gray-800); outline: none; width: 100%;
        }
        .search-box input::placeholder { color: var(--gray-400); }

        .filter-select {
            border: 2px solid var(--gray-200); border-radius: 8px; padding: 8px 14px;
            font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 500;
            color: var(--gray-800); background: var(--gray-50); cursor: pointer; outline: none; transition: border-color 0.2s;
            max-width: 180px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap;
        }
        .filter-select:focus { border-color: var(--purple); }

        .btn-nuevo {
            display: flex; align-items: center; gap: 8px;
            background: var(--purple); color: white; border: none; border-radius: 8px;
            padding: 10px 18px; font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .btn-nuevo:hover { background: var(--purple-light); transform: translateY(-1px); }
        .btn-nuevo svg { width: 18px; height: 18px; fill: white; }

        /* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
        .main { max-width: 1100px; margin: 0 auto; padding: 24px; }

        /* ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ */
        .stats-row {
            display: flex;
            align-items: stretch;
            gap: 0;
            margin-bottom: 24px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .stat-card {
            flex: 1;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            border-right: 1px solid var(--gray-200);
            border-top: 3px solid transparent;
            transition: background 0.15s;
        }
        .stat-card:last-child { border-right: none; }
        .stat-card:hover { background: var(--gray-50); }

        .stat-card.total  { border-top-color: var(--purple); }
        .stat-card.s-Presentado { border-top-color: #0369a1; }
        .stat-card.s-EnRevision { border-top-color: #eab308; }
        .stat-card.s-EnComision { border-top-color: #7c3aed; }
        .stat-card.s-Aprobado   { border-top-color: #22c55e; }
        .stat-card.s-Rechazado  { border-top-color: #ef4444; }
        .stat-card.s-Archivado  { border-top-color: #9ca3af; }
        .stat-card.s-Listo      { border-top-color: #059669; }

        .stat-label { font-size: 10px; font-weight: 700; color: var(--gray-400); text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .stat-value { font-size: 22px; font-weight: 800; color: var(--purple); line-height: 1; }

        @media (max-width: 700px) {
            .stats-row { flex-wrap: wrap; }
            .stat-card { flex: 1 1 calc(33% - 1px); border-right: 1px solid var(--gray-200); border-bottom: 1px solid var(--gray-200); }
        }

        /* ‚îÄ‚îÄ‚îÄ LISTA ‚îÄ‚îÄ‚îÄ */
        .projects-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .projects-title  { font-size: 15px; font-weight: 700; color: var(--gray-800); }
        .count-badge     { background: var(--purple-faint); color: var(--purple); font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 100px; }
        .projects-list   { display: flex; flex-direction: column; gap: 10px; }

        .empty-state { text-align: center; padding: 80px 20px; color: var(--gray-400); }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; font-weight: 700; color: var(--gray-600); margin-bottom: 8px; }
        .empty-state p  { font-size: 14px; }

        /* ‚îÄ‚îÄ‚îÄ TARJETA ‚îÄ‚îÄ‚îÄ */
        .project-card {
            background: white; border-radius: var(--radius); box-shadow: var(--shadow);
            overflow: hidden; border-left: 4px solid var(--gray-200); transition: all 0.2s; cursor: pointer;
        }
        .project-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-1px); }

        .project-card-inner { padding: 16px 18px; display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start; }

        .project-top    { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 6px; }
        .project-title  { font-size: 15px; font-weight: 700; color: var(--gray-800); }

        .project-meta   { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; font-size: 12px; color: var(--gray-400); font-weight: 500; margin-bottom: 4px; }
        .project-meta:last-of-type { margin-bottom: 10px; }
        .meta-item      { display: flex; align-items: center; gap: 4px; }
        .meta-item svg  { width: 13px; height: 13px; fill: var(--gray-400); }

        .project-desc   { font-size: 13px; color: var(--gray-600); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .project-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 10px; flex-shrink: 0; }

        .estado-badge-select {
            border: none; border-radius: 6px; padding: 6px 10px;
            font-family: 'Montserrat', sans-serif; font-size: 11px; font-weight: 700;
            cursor: pointer; appearance: none; -webkit-appearance: none; text-align: center; transition: all 0.2s;
        }

        .action-btns { display: flex; gap: 6px; }

        .icon-btn {
            width: 34px; height: 34px; border-radius: 50%; border: 2px solid var(--gray-200);
            background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; padding: 0;
        }
        .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .icon-btn svg { width: 16px; height: 16px; }

        .icon-btn-preview  { border-color: var(--purple); }
        .icon-btn-preview svg { fill: var(--purple); }
        .icon-btn-preview:hover { background: var(--purple); }
        .icon-btn-preview:hover svg { fill: white; }

        .icon-btn-download { border-color: var(--green); }
        .icon-btn-download svg { fill: var(--green); }
        .icon-btn-download:hover { background: var(--green); }
        .icon-btn-download:hover svg { fill: white; }

        .icon-btn-delete   { border-color: var(--red); }
        .icon-btn-delete svg { fill: var(--red); }
        .icon-btn-delete:hover { background: var(--red); }
        .icon-btn-delete:hover svg { fill: white; }

        .icon-btn-edit     { border-color: var(--orange); }
        .icon-btn-edit svg { fill: var(--orange); }
        .icon-btn-edit:hover { background: var(--orange); }
        .icon-btn-edit:hover svg { fill: white; }

        /* Google Docs button */
        .icon-btn-docs { border-color: var(--gdoc-blue); }
        .icon-btn-docs svg { fill: var(--gdoc-blue); }
        .icon-btn-docs:hover { background: var(--gdoc-blue); }
        .icon-btn-docs:hover svg { fill: white; }

        /* ‚îÄ‚îÄ‚îÄ ESTADOS ‚îÄ‚îÄ‚îÄ */
        .estado-Presentado { background: #e0f2fe; color: #0369a1; }
        .estado-EnRevision { background: #fef9c3; color: #854d0e; }
        .estado-EnComision { background: #ede9fe; color: #6d28d9; }
        .estado-Aprobado   { background: #dcfce7; color: #15803d; }
        .estado-Rechazado  { background: #fee2e2; color: #b91c1c; }
        .estado-Archivado  { background: #f3f4f6; color: #6b7280; }
        .estado-Listo      { background: #d1fae5; color: #065f46; }

        .border-Presentado { border-left-color: #0369a1; }
        .border-EnRevision { border-left-color: #eab308; }
        .border-EnComision { border-left-color: #7c3aed; }
        .border-Aprobado   { border-left-color: #22c55e; }
        .border-Rechazado  { border-left-color: #ef4444; }
        .border-Archivado  { border-left-color: #9ca3af; }
        .border-Listo      { border-left-color: #059669; }

        /* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }

        .modal { background: white; border-radius: 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; overflow: hidden; animation: modalIn 0.25s ease; }

        @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }

        .modal-header { background: var(--purple); padding: 18px 24px; display: flex; align-items: center; justify-content: space-between; }
        .modal-title  { font-size: 16px; font-weight: 700; color: white; }

        .modal-close {
            width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.15);
            border: none; cursor: pointer; color: white; font-size: 18px;
            display: flex; align-items: center; justify-content: center; transition: background 0.2s; line-height: 1;
        }
        .modal-close:hover { background: rgba(255,255,255,0.25); }

        .modal-body { padding: 24px; }

        /* ‚îÄ‚îÄ‚îÄ FORM ‚îÄ‚îÄ‚îÄ */
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; min-width: 0; }
        .form-group.full { grid-column: 1 / -1; }
        .form-label { font-size: 12px; font-weight: 700; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.5px; }

        .form-input, .form-select, .form-textarea {
            border: 2px solid var(--gray-200); border-radius: 8px; padding: 10px 14px;
            font-family: 'Montserrat', sans-serif; font-size: 14px; font-weight: 500;
            color: var(--gray-800); background: var(--gray-50); transition: border-color 0.2s; outline: none;
            width: 100%; text-overflow: ellipsis; overflow: hidden;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--purple); background: white; }
        .form-textarea { resize: vertical; min-height: 80px; }

        /* ‚îÄ‚îÄ‚îÄ UPLOAD TABS ‚îÄ‚îÄ‚îÄ */

        /* ‚îÄ‚îÄ‚îÄ GOOGLE DOCS ZONE ‚îÄ‚îÄ‚îÄ */
        .doc-create-zone {
            border: 2px dashed var(--gray-200); border-radius: 8px; padding: 28px;
            text-align: center; background: var(--gray-50); transition: all 0.2s;
        }
        .doc-create-zone.has-doc { border-color: var(--gdoc-blue); background: #e8f0fe; }

        .btn-create-doc {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--gdoc-blue); color: white; border: none; border-radius: 8px;
            padding: 11px 20px; font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; margin-top: 10px;
        }
        .btn-create-doc:hover { background: #1557b0; transform: translateY(-1px); }
        .btn-create-doc:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .doc-url-preview {
            display: none; margin-top: 12px; padding: 10px 14px;
            background: white; border-radius: 8px; border: 1px solid #bee3f8;
            font-size: 12px; color: var(--gray-600);
        }
        .doc-url-preview a {
            color: var(--gdoc-blue); font-weight: 700; text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px; margin-top: 4px;
        }
        .doc-url-preview a:hover { text-decoration: underline; }

        .doc-existing-info {
            display: none; margin-top: 10px; padding: 10px 14px;
            background: #e8f0fe; border-radius: 8px; border: 1px solid #bee3f8;
            font-size: 12px; color: #1558a0; font-weight: 600;
        }
        .doc-existing-info a { color: var(--gdoc-blue); text-decoration: none; }
        .doc-existing-info a:hover { text-decoration: underline; }

        /* ‚îÄ‚îÄ‚îÄ MODAL FOOTER ‚îÄ‚îÄ‚îÄ */
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 10px; }

        .btn { border: none; border-radius: 8px; padding: 10px 20px; font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-cancel { background: var(--gray-100); color: var(--gray-600); }
        .btn-cancel:hover { background: var(--gray-200); }
        .btn-save { background: var(--purple); color: white; }
        .btn-save:hover { background: var(--purple-light); }
        .btn-save:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ */


        .form-modal .modal { max-width: 580px; }
        .form-modal .modal-body { max-height: calc(90vh - 130px); overflow-y: auto; }

        /* ‚îÄ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ‚îÄ */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(48,17,94,0.5); z-index: 500; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }

        .loading-box { background: white; border-radius: 14px; padding: 30px 40px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }

        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid var(--gray-200); border-top-color: var(--purple);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; font-weight: 600; color: var(--gray-600); }

        /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--gray-800); color: white; padding: 12px 24px;
            border-radius: 8px; font-size: 13px; font-weight: 600;
            opacity: 0; transition: all 0.3s ease; z-index: 999; white-space: nowrap;
        }
        .toast.show    { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { background: #15803d; }
        .toast.error   { background: #b91c1c; }

        /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            .toolbar { padding: 10px 14px; }
            .main { padding: 14px; }
            .form-grid { grid-template-columns: 1fr; }
            .header-titles h1 { font-size: 15px; }
            .project-card-inner { grid-template-columns: 1fr; }
            .project-actions { flex-direction: row; align-items: center; justify-content: space-between; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <!-- ‚îÄ‚îÄ AUTH GUARD ‚îÄ‚îÄ -->
    <script>
    (function() {
        var saved = sessionStorage.getItem('lla_user');
        if (!saved) { window.location.replace('index.html'); return; }
        try { JSON.parse(saved); } catch(e) { window.location.replace('index.html'); }
    })();
    </script>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-box">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Cargando proyectos...</div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <!-- HEADER -->
    <div id="header">
        <div class="header-left">
            <a href="index.html" class="back-btn" title="Volver al inicio">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </a>
            <div class="header-titles">
                <h1>üìö Biblioteca de Proyectos</h1>
                <p>Seguimiento de proyectos legislativos</p>
            </div>
        </div>
        <!-- Avatar de usuario -->
        <div id="header-user" style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
            <span id="header-user-name" style="font-size:12px;font-weight:600;color:rgba(255,255,255,0.6);"></span>
            <div id="header-avatar-wrap"></div>
        </div>
    </div>

    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="search-box">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="search-input" placeholder="Buscar proyectos...">
            </div>
            <select class="filter-select" id="filter-estado">
                <option value="">Todos los estados</option>
                <option value="Presentado">Presentado</option>
                <option value="EnRevision">En Revisi√≥n</option>
                <option value="EnComision">En Comisi√≥n</option>
                <option value="Aprobado">Aprobado</option>
                <option value="Rechazado">Rechazado</option>
                <option value="Archivado">Archivado</option>
                <option value="Listo">Listo</option>
            </select>
            <select class="filter-select" id="filter-comision">
                <option value="">Todas las comisiones</option>
            </select>
        </div>
        <button class="btn-nuevo" id="btn-nuevo-proyecto">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            Nuevo Proyecto
        </button>
    </div>

    <!-- MAIN -->
    <div class="main">
        <div class="stats-row" id="stats-row"></div>
        <div class="projects-header">
            <div class="projects-title">Proyectos</div>
            <span class="count-badge" id="count-badge">0</span>
        </div>
        <div class="projects-list" id="projects-list"></div>
    </div>

    <!-- MODAL: FORM -->
    <div class="modal-overlay form-modal" id="form-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="form-modal-title">Nuevo Proyecto</span>
                <button class="modal-close" id="form-modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full">
                        <label class="form-label">T√≠tulo del proyecto *</label>
                        <input type="text" class="form-input" id="f-titulo" placeholder="Ej: Ordenanza de arbolado urbano...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado *</label>
                        <select class="form-select" id="f-estado" onchange="toggleFecha(this.value)">
                            <option value="" disabled selected>Seleccionar estado...</option>
                            <option value="Presentado">Presentado</option>
                            <option value="EnRevision">En Revisi√≥n</option>
                            <option value="EnComision">En Comisi√≥n</option>
                            <option value="Aprobado">Aprobado</option>
                            <option value="Rechazado">Rechazado</option>
                            <option value="Archivado">Archivado</option>
                            <option value="Listo">Listo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comisi√≥n *</label>
                        <select class="form-select" id="f-comision"></select>
                    </div>
                    <div class="form-group" id="fecha-group">
                        <label class="form-label">Fecha de presentaci√≥n</label>
                        <input type="date" class="form-input" id="f-fecha">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de creaci√≥n</label>
                        <input type="date" class="form-input" id="f-fecha-creacion" readonly style="background:#f3f4f6;cursor:not-allowed;color:#9ca3af;">
                    </div>
                    <div class="form-group full" id="expediente-group">
                        <label class="form-label">N√∫mero de expediente</label>
                        <input type="text" class="form-input" id="f-expediente" placeholder="Ej: EXP-2025-001">
                    </div>
                    <div class="form-group full">
                        <label class="form-label">Descripci√≥n / resumen</label>
                        <textarea class="form-textarea" id="f-descripcion" placeholder="Breve descripci√≥n del proyecto..."></textarea>
                    </div>

                    <!-- ARCHIVO: Google Docs -->
                    <div class="form-group full">
                        <label class="form-label">Archivo *</label>
                        <div id="upload-doc-section">
                            <div class="doc-create-zone" id="doc-create-zone">
                                <div class="upload-icon" id="doc-upload-icon">üìù</div>
                                <div class="upload-text" id="doc-upload-text">Redact√° el proyecto en Google Docs</div>
                                <div class="upload-sub" id="doc-upload-sub">
                                    Se crea un documento con el membrete del Bloque, la fecha de hoy y listo para editar
                                </div>
                                <button type="button" class="btn-create-doc" id="btn-create-doc" onclick="crearGoogleDoc()">
                                    <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                                    Crear documento
                                </button>
                                <!-- Preview link despu√©s de crear (modo nuevo) -->
                                <div class="doc-url-preview" id="doc-url-preview">
                                    ‚úÖ Documento creado y abierto en una nueva pesta√±a.
                                    <br>
                                    <a id="doc-url-link" href="" target="_blank">
                                        <svg viewBox="0 0 24 24" width="13" height="13" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                                        Volver a abrir ‚Üí
                                    </a>
                                </div>
                                <!-- Separador: vincular doc existente -->
                                <div id="doc-link-section" style="margin-top:16px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
                                        <div style="flex:1;height:1px;background:var(--gray-200);"></div>
                                        <span style="font-size:11px;font-weight:600;color:var(--gray-400);white-space:nowrap;">O vincul√° uno existente</span>
                                        <div style="flex:1;height:1px;background:var(--gray-200);"></div>
                                    </div>
                                    <input type="url" id="doc-link-input" placeholder="Peg√° el link de Google Docs..."
                                        class="form-input" style="font-size:13px;"
                                        oninput="onDocLinkInput(this.value)"
                                        onfocus="this.style.borderColor='var(--gdoc-blue)'"
                                        onblur="this.style.borderColor='var(--gray-200)'">
                                    <div id="doc-link-error" style="display:none;margin-top:6px;font-size:12px;color:#ef4444;font-weight:600;">
                                        ‚ö†Ô∏è El link debe ser de Google Docs (docs.google.com/document/...)
                                    </div>
                                    <div id="doc-link-disclaimer" style="display:none;margin-top:8px;padding:10px 12px;
                                        background:#fffbeb;border:1px solid #fde68a;border-radius:8px;
                                        font-size:12px;color:#92400e;line-height:1.5;">
                                        ‚ö†Ô∏è <strong>Acordate de compartir el documento</strong> con toda la n√≥mina del Bloque antes de guardarlo, para que todos puedan acceder.
                                    </div>
                                </div>

                                <!-- Modo edici√≥n: ya tiene doc guardado ‚Üí mostrar "Seguir editando" -->
                                <div id="doc-existing-section" style="display:none; margin-top:10px; text-align:center;">
                                    <a id="btn-seguir-editando" href="" target="_blank" class="btn-create-doc" style="display:inline-flex;">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                                        Seguir editando ‚Üí
                                    </a>
                                    <div style="margin-top:8px; font-size:11px; color:var(--gray-400);">
                                        <button type="button" onclick="mostrarFormCrearDoc()" style="background:none;border:none;color:var(--gdoc-blue);font-size:11px;font-weight:600;cursor:pointer;font-family:'Montserrat',sans-serif;padding:0;">
                                            Reemplazar documento
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="form-cancel">Cancelar</button>
                <button class="btn btn-save" id="form-save">Guardar Proyecto</button>
            </div>
        </div>
    </div>



    <!-- MODAL: CONFIRMAR ELIMINACI√ìN -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal" style="max-width:400px;">
            <div class="modal-header">
                <span class="modal-title">Confirmar eliminaci√≥n</span>
                <button class="modal-close" id="confirm-modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <p style="font-size:14px;color:var(--gray-600);line-height:1.6;">
                    ¬øEst√°s seguro de que quer√©s eliminar el proyecto <strong id="confirm-nombre"></strong>?<br>Esta acci√≥n no se puede deshacer.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="confirm-cancel">Cancelar</button>
                <button class="btn" style="background:var(--red);color:white;" id="confirm-delete">Eliminar</button>
            </div>
        </div>
    </div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbx-_LWMHLPYPvl1A-ilyOPmzh1jIMOKOKhPT0YQXlfHGIn-4Lc0bRuRHXv5zA5jiPd6/exec';

const COMISIONES = [
    'Obras y Servicios P√∫blicos',
    'Interpretaci√≥n, Reglamento y Legislaci√≥n',
    'Desarrollo Humano, G√©nero, Familias, Ni√±ez, Adolescencia y Tercera Edad',
    'Salud',
    'Educaci√≥n',
    'Planeamiento Urbano',
    'Presupuesto y Hacienda',
    'Seguridad'
];

const ESTADOS = {
    'Presentado': { label: 'Presentado',  cls: 'estado-Presentado', border: 'border-Presentado' },
    'EnRevision': { label: 'En Revisi√≥n', cls: 'estado-EnRevision', border: 'border-EnRevision' },
    'EnComision': { label: 'En Comisi√≥n', cls: 'estado-EnComision', border: 'border-EnComision' },
    'Aprobado':   { label: 'Aprobado',    cls: 'estado-Aprobado',   border: 'border-Aprobado'   },
    'Rechazado':  { label: 'Rechazado',   cls: 'estado-Rechazado',  border: 'border-Rechazado'  },
    'Archivado':  { label: 'Archivado',   cls: 'estado-Archivado',  border: 'border-Archivado'  },
    'Listo':      { label: 'Listo',       cls: 'estado-Listo',     border: 'border-Listo'     }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTADO APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let proyectos    = [];
let editingId    = null;
let deleteId     = null;
let pendingDocUrl = null;   // ‚Üê nuevo: URL del Google Doc pendiente

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
    loadUserSession();
    poblarSelectsComisiones();
    bindEvents();
    await loadProyectos();
}

function loadUserSession() {
    try {
        const user = JSON.parse(sessionStorage.getItem('lla_user') || '{}');
        if (!user.name) return;

        document.getElementById('header-user-name').textContent = user.given_name || user.name;

        const wrap = document.getElementById('header-avatar-wrap');
        if (user.picture) {
            wrap.innerHTML = `<img src="${user.picture}" style="width:34px;height:34px;border-radius:50%;border:2px solid rgba(167,139,250,0.6);object-fit:cover;cursor:pointer;" title="${user.name}" referrerpolicy="no-referrer" onclick="window.location='index.html'">`;
        } else {
            const inicial = (user.name || 'U')[0].toUpperCase();
            wrap.innerHTML = `<div style="width:34px;height:34px;border-radius:50%;background:rgba(167,139,250,0.3);border:2px solid rgba(167,139,250,0.6);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:white;cursor:pointer;" title="${user.name}" onclick="window.location='index.html'">${inicial}</div>`;
        }
    } catch(e) {}
}

function poblarSelectsComisiones() {
    ['f-comision', 'filter-comision'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        if (id === 'f-comision') sel.innerHTML = '<option value="">Sin comisi√≥n asignada</option>';
        COMISIONES.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.textContent = c;
            sel.appendChild(opt);
        });
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProyectos() {
    showLoading('Cargando proyectos...');
    try {
        const res  = await fetch(SHEET_URL);
        const data = await res.json();
        proyectos  = Array.isArray(data) ? data : [];
        renderAll();
    } catch (err) {
        showToast('Error al cargar proyectos', 'error');
        console.error(err);
    } finally {
        hideLoading();
    }
}

async function apiGet(params) {
    const url = new URL(SHEET_URL);
    Object.entries(params).forEach(([k, v]) => {
        if (v !== null && v !== undefined && v !== '') {
            url.searchParams.set(k, String(v));
        }
    });
    const res = await fetch(url.toString());
    return await res.json();
}

async function apiPost(params) {
    await fetch(SHEET_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(params)
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREAR GOOGLE DOC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onDocLinkInput(value) {
    const errorDiv  = document.getElementById('doc-link-error');
    const disclaimer = document.getElementById('doc-link-disclaimer');
    const val = value.trim();

    if (!val) {
        // Campo vac√≠o ‚Äî resetear
        errorDiv.style.display = 'none';
        disclaimer.style.display = 'none';
        // Solo limpiar pendingDocUrl si no vino de crear doc
        if (!document.getElementById('doc-url-preview').style.display || document.getElementById('doc-url-preview').style.display === 'none') {
            pendingDocUrl = null;
        }
        return;
    }

    // Validar que sea un Google Doc
    const isGoogleDoc = /https:\/\/docs\.google\.com\/document\/d\//.test(val);
    if (!isGoogleDoc) {
        errorDiv.style.display = 'block';
        disclaimer.style.display = 'none';
        pendingDocUrl = null;
        return;
    }

    // Link v√°lido
    errorDiv.style.display = 'none';
    disclaimer.style.display = 'block';
    pendingDocUrl = val;
}

function mostrarFormCrearDoc() {
    // Resetear todo el estado del tab de docs ‚Üí empty state
    document.getElementById('doc-existing-section').style.display = 'none';
    document.getElementById('doc-url-preview').style.display = 'none';
    document.getElementById('doc-create-zone').classList.remove('has-doc');
    document.getElementById('btn-create-doc').style.display = '';
    document.getElementById('doc-upload-icon').style.display = '';
    document.getElementById('doc-upload-text').style.display = '';
    document.getElementById('doc-upload-sub').style.display = '';
    document.getElementById('doc-link-section').style.display = '';
    document.getElementById('doc-link-input').value = '';
    document.getElementById('doc-link-error').style.display = 'none';
    document.getElementById('doc-link-disclaimer').style.display = 'none';
    pendingDocUrl = null;
}

async function crearGoogleDoc() {
    // Validar campos obligatorios antes de crear el doc
    const tituloVal   = document.getElementById('f-titulo').value.trim();
    const estadoVal   = document.getElementById('f-estado').value;
    const comisionVal = document.getElementById('f-comision').value;

    if (!tituloVal)   { showToast('El t√≠tulo es obligatorio', 'error'); return; }
    if (!estadoVal)   { showToast('El estado es obligatorio', 'error'); return; }
    if (!comisionVal) { showToast('La comisi√≥n es obligatoria', 'error'); return; }

    const titulo = tituloVal;
    const fecha  = document.getElementById('f-fecha').value || new Date().toISOString().slice(0, 10);

    const btn = document.getElementById('btn-create-doc');
    btn.disabled = true;
    btn.textContent = 'Creando...';

    showLoading('Creando documento en Google Docs...');
    try {
        const result = await apiGet({ action: 'createDoc', titulo, fecha });

        if (!result || !result.docUrl) {
            throw new Error('No se recibi√≥ URL del documento');
        }

        pendingDocUrl = result.docUrl;

        // Mostrar preview
        const preview = document.getElementById('doc-url-preview');
        document.getElementById('doc-url-link').href = pendingDocUrl;
        preview.style.display = 'block';
        document.getElementById('doc-create-zone').classList.add('has-doc');

        // Abrir en nueva pesta√±a
        window.open(pendingDocUrl, '_blank');

        // Campos ya validados arriba ‚Äî guardar autom√°ticamente
        showToast('Documento creado, guardando proyecto...', 'success');
        await new Promise(r => setTimeout(r, 800));
        await saveForm();
    } catch (err) {
        console.error(err);
        showToast('Error al crear el documento. Verific√° el Apps Script.', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Crear documento`;
        hideLoading();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
    renderStats();
    renderList();
}

function renderStats() {
    const counts = {};
    Object.keys(ESTADOS).forEach(k => { counts[k] = 0; });
    proyectos.forEach(p => { counts[p.estado] = (counts[p.estado] || 0) + 1; });

    document.getElementById('stats-row').innerHTML = `
        <div class="stat-card total">
            <div class="stat-label">Total</div>
            <div class="stat-value">${proyectos.length}</div>
        </div>
        ${Object.entries(ESTADOS).map(([k,v]) => `
            <div class="stat-card s-${k}">
                <div class="stat-label">${v.label}</div>
                <div class="stat-value">${counts[k]||0}</div>
            </div>
        `).join('')}
    `;
}

function getFiltered() {
    const q   = document.getElementById('search-input').value.toLowerCase();
    const est = document.getElementById('filter-estado').value;
    const com = document.getElementById('filter-comision').value;

    return proyectos.filter(p => {
        const matchQ   = !q   || (p.titulo||'').toLowerCase().includes(q) || (p.descripcion||'').toLowerCase().includes(q);
        const matchEst = !est || p.estado === est;
        const matchCom = !com || p.comision === com;
        return matchQ && matchEst && matchCom;
    }).sort((a, b) => Number(b.id) - Number(a.id));
}

function renderList() {
    const filtered = getFiltered();
    const list = document.getElementById('projects-list');
    document.getElementById('count-badge').textContent = filtered.length;

    if (filtered.length === 0) {
        list.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üîç</div>
                <h3>${proyectos.length === 0 ? 'No hay proyectos todav√≠a' : 'Sin resultados'}</h3>
                <p>${proyectos.length === 0 ? 'Hac√© click en "Nuevo Proyecto" para agregar el primero' : 'Prob√° cambiando los filtros'}</p>
            </div>`;
        return;
    }

    list.innerHTML = filtered.map(p => {
        const est      = ESTADOS[p.estado] || ESTADOS['Presentado'];
        const fecha    = p.fecha ? formatFecha(p.fecha) : '‚Äî';
        const tieneDoc = !!p.docUrl;
        const estadoOpts = Object.entries(ESTADOS).map(([k,v]) =>
            `<option value="${k}" ${p.estado===k?'selected':''}>${v.label}</option>`
        ).join('');

        return `
        <div class="project-card ${est.border}${tieneDoc ? ' has-doc-only' : ''}" ${tieneDoc ? `onclick="window.open('${escHtml(p.docUrl)}', '_blank')"` : ''}>
            <div class="project-card-inner">
                <div class="project-main">
                    <div class="project-top">
                        <div class="project-title">${escHtml(p.titulo)}</div>
                    </div>
                    <div class="project-meta project-meta-row">
                        ${fecha !== '‚Äî' ? `<span class="meta-item" title="Fecha de presentaci√≥n">
                            <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                            Presentado: ${fecha}
                        </span>` : ''}
                        ${p.fechaCreacion ? `<span class="meta-item" title="Fecha de creaci√≥n">
                            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg>
                            Creado: ${formatFecha(p.fechaCreacion)}
                        </span>` : ''}
                    </div>
                    <div class="project-meta project-meta-row">
                        ${p.comision ? `<span class="meta-item">
                            <svg viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/></svg>
                            ${escHtml(p.comision)}
                        </span>` : ''}
                        ${p.expediente ? `<span class="meta-item">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                            ${escHtml(p.expediente)}
                        </span>` : ''}
                        
                        ${tieneDoc ? `<span class="meta-item" style="color:#1a73e8">
                            <svg viewBox="0 0 24 24" style="fill:#1a73e8"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                            Google Doc
                        </span>` : ''}
                    </div>
                    ${p.descripcion ? `<div class="project-desc">${escHtml(p.descripcion)}</div>` : ''}
                </div>
                <div class="project-actions">
                    <select class="estado-badge-select ${est.cls}" onchange="cambiarEstado('${p.id}', this.value)" onclick="event.stopPropagation()">
                        ${estadoOpts}
                    </select>
                    <div class="action-btns" onclick="event.stopPropagation()">
                        
                        ${tieneDoc ? `
                        <button class="icon-btn icon-btn-docs" title="Abrir en Google Docs" onclick="window.open('${escHtml(p.docUrl)}', '_blank')">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        </button>
                        ` : ''}
                        <button class="icon-btn icon-btn-edit" title="Editar" onclick="editProyecto('${p.id}')">
                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                        <button class="icon-btn icon-btn-delete" title="Eliminar" onclick="promptDelete('${p.id}')">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACCIONES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function cambiarEstado(id, nuevoEstado) {
    const p = proyectos.find(x => String(x.id) === String(id));
    if (p) p.estado = nuevoEstado;
    renderAll();
    try {
        await apiGet({ action: 'updateEstado', id, estado: nuevoEstado });
    } catch (err) {
        showToast('Error al guardar el estado', 'error');
    }
}

function promptDelete(id) {
    const p = proyectos.find(x => String(x.id) === String(id));
    if (!p) return;
    deleteId = id;
    document.getElementById('confirm-nombre').textContent = `"${p.titulo}"`;
    document.getElementById('confirm-modal').classList.add('active');
}

async function doDelete() {
    if (!deleteId) return;
    document.getElementById('confirm-modal').classList.remove('active');
    showLoading('Eliminando proyecto...');
    try {
        await apiGet({ action: 'delete', id: deleteId });
        proyectos = proyectos.filter(x => String(x.id) !== String(deleteId));
        deleteId = null;
        renderAll();
        showToast('Proyecto eliminado', 'success');
    } catch (err) {
        showToast('Error al eliminar', 'error');
    } finally {
        hideLoading();
    }
}

function editProyecto(id) {
    const p = proyectos.find(x => String(x.id) === String(id));
    if (!p) return;
    editingId = id; pendingDocUrl = null;

    document.getElementById('form-modal-title').textContent  = 'Editar Proyecto';
    document.getElementById('f-titulo').value          = p.titulo        || '';
    document.getElementById('f-estado').value          = p.estado        || 'Presentado';
    document.getElementById('f-comision').value        = p.comision      || '';
    document.getElementById('f-fecha').value           = p.fecha         || '';
    document.getElementById('f-fecha-creacion').value  = p.fechaCreacion || '';
    document.getElementById('f-expediente').value      = p.expediente    || '';
    document.getElementById('f-descripcion').value     = p.descripcion   || '';

    // Si tiene docUrl guardado, pre-cargar para que no se pierda al guardar
    if (p.docUrl) pendingDocUrl = p.docUrl;

    // Mostrar info del Google Doc existente
    const docExistingSection = document.getElementById('doc-existing-section');
    const docUrlPreview = document.getElementById('doc-url-preview');
    if (p.docUrl) {
        // Mostrar bot√≥n "Seguir editando" con la URL guardada
        document.getElementById('btn-seguir-editando').href = p.docUrl;
        docExistingSection.style.display = 'block';
        // Ocultar √≠cono, descripci√≥n, bot√≥n crear y link input
        document.getElementById('btn-create-doc').style.display = 'none';
        document.getElementById('doc-upload-icon').style.display = 'none';
        document.getElementById('doc-upload-text').style.display = 'none';
        document.getElementById('doc-upload-sub').style.display = 'none';
        document.getElementById('doc-link-section').style.display = 'none';
        docUrlPreview.style.display = 'none';
        document.getElementById('doc-create-zone').classList.add('has-doc');
    } else {
        docExistingSection.style.display = 'none';
        document.getElementById('btn-create-doc').style.display = '';
        docUrlPreview.style.display = 'none';
    }

    toggleFecha(document.getElementById('f-estado').value);
    document.getElementById('form-modal').classList.add('active');
}

async function saveForm() {
    const titulo   = document.getElementById('f-titulo').value.trim();
    const estado   = document.getElementById('f-estado').value;
    const comision = document.getElementById('f-comision').value;

    if (!titulo)   { showToast('El t√≠tulo es obligatorio', 'error'); return; }
    if (!estado)   { showToast('El estado es obligatorio', 'error'); return; }
    if (!comision) { showToast('La comisi√≥n es obligatoria', 'error'); return; }

    // Validar archivo: necesita PDF nuevo, docUrl nuevo, o (en edici√≥n) archivo ya existente
    const existing = editingId ? proyectos.find(x => String(x.id) === String(editingId)) : null;
    const yaHayArchivo = existing && existing.docUrl;
    if (!editingId && !pendingDocUrl) {
        showToast('Cre√° o vincul√° un Google Doc', 'error'); return;
    }

    const saveBtn = document.getElementById('form-save');
    saveBtn.disabled = true;
    showLoading(editingId ? 'Guardando cambios...' : 'Creando proyecto...');

    try {

        const body = {
            action:         editingId ? 'update' : 'add',
            id:             editingId,
            titulo,
            estado,
            comision,
            fecha:          document.getElementById('f-fecha').value,
            fechaCreacion:  editingId ? (existing?.fechaCreacion || '') : new Date().toISOString().slice(0,10),
            expediente:     document.getElementById('f-expediente').value.trim(),
            descripcion:    document.getElementById('f-descripcion').value.trim(),
            // Google Doc URL: si se cre√≥ uno nuevo en esta sesi√≥n, usarlo; si no, preservar el existente
            docUrl:         pendingDocUrl || (existing?.docUrl || '')
        };

        showLoading('Guardando...');
        await apiPost(body);
        closeFormModal();
        showToast(editingId ? 'Proyecto actualizado ‚úì' : 'Proyecto creado ‚úì', 'success');
        await new Promise(r => setTimeout(r, 3000));
        await loadProyectos();

    } catch (err) {
        showToast('Error al guardar. Intent√° de nuevo.', 'error');
        console.error(err);
    } finally {
        saveBtn.disabled = false;
        hideLoading();
    }
}

function closeFormModal() {
    document.getElementById('form-modal').classList.remove('active');
    ['f-titulo','f-expediente','f-descripcion','f-fecha-creacion'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('f-estado').value   = 'Presentado';
    document.getElementById('f-comision').value = '';
    document.getElementById('f-fecha').value    = '';

    document.getElementById('form-modal-title').textContent  = 'Nuevo Proyecto';
    // Reset Google Docs
    document.getElementById('doc-url-preview').style.display = 'none';
    document.getElementById('doc-existing-section').style.display = 'none';
    document.getElementById('doc-create-zone').classList.remove('has-doc');
    document.getElementById('doc-url-link').href = '';
    document.getElementById('btn-create-doc').style.display = '';
    document.getElementById('doc-link-input').value = '';
    document.getElementById('doc-link-error').style.display = 'none';
    document.getElementById('doc-link-disclaimer').style.display = 'none';
    editingId    = null;
    pendingDocUrl = null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLoading(text) {
    document.getElementById('loading-text').textContent = text || 'Cargando...';
    document.getElementById('loading-overlay').classList.add('active');
}
function hideLoading() { document.getElementById('loading-overlay').classList.remove('active'); }

let toastTimer = null;
function showToast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className   = `toast ${type} show`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { t.className = 'toast'; }, 3000);
}

function escHtml(str) {
    if (!str) return '';
    str = String(str);
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatFecha(val) {
    if (!val || val === '‚Äî') return '‚Äî';
    const s = String(val).trim();
    if (!s) return '‚Äî';
    const dt = new Date(s);
    if (!isNaN(dt)) {
        return `${dt.getDate()}/${dt.getMonth() + 1}/${dt.getFullYear()}`;
    }
    return s;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BIND EVENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function bindEvents() {
    document.getElementById('btn-nuevo-proyecto').addEventListener('click', () => {
        editingId = null;
        document.getElementById('f-estado').value = '';
        document.getElementById('f-fecha').value = '';
        document.getElementById('f-fecha-creacion').value = new Date().toISOString().slice(0,10);
            toggleFecha('');
        document.getElementById('form-modal').classList.add('active');
    });

    document.getElementById('form-modal-close').addEventListener('click', closeFormModal);
    document.getElementById('form-cancel').addEventListener('click', closeFormModal);
    document.getElementById('form-modal').addEventListener('click', e => { if (e.target.id==='form-modal') closeFormModal(); });
    document.getElementById('form-save').addEventListener('click', saveForm);



    document.getElementById('confirm-modal-close').addEventListener('click', () => { document.getElementById('confirm-modal').classList.remove('active'); deleteId=null; });
    document.getElementById('confirm-cancel').addEventListener('click',      () => { document.getElementById('confirm-modal').classList.remove('active'); deleteId=null; });
    document.getElementById('confirm-delete').addEventListener('click', doDelete);
    document.getElementById('confirm-modal').addEventListener('click', e => { if (e.target.id==='confirm-modal') { document.getElementById('confirm-modal').classList.remove('active'); deleteId=null; } });

    document.getElementById('search-input').addEventListener('input', renderList);
    document.getElementById('filter-estado').addEventListener('change', renderList);
    document.getElementById('filter-comision').addEventListener('change', renderList);


}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOGGLE FECHA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFecha(estado) {
    const noPresenta = ['EnRevision', 'Archivado', 'Listo', ''];
    const fechaGroup = document.getElementById('fecha-group');
    const expGroup   = document.getElementById('expediente-group');
    if (noPresenta.includes(estado)) {
        fechaGroup.style.display = 'none';
        expGroup.style.display = 'none';
        document.getElementById('f-fecha').value = '';
        document.getElementById('f-expediente').value = '';
    } else {
        fechaGroup.style.display = '';
        expGroup.style.display = '';
        expGroup.classList.add('full');
    }
}

init();
</script>
</body>
</html>
